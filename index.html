<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Timetable Scheduler â€” Enhanced</title>
  <style>
    :root{ --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#60a5fa; --text:#e6eef8; --slot-height:60px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #071226 100%);color:var(--text)}
    .app{max-width:1200px;margin:20px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--text);cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#60e6a8);border:none;color:#05202b}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px;margin-top:14px}
    .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .task-bank-controls{display:flex;gap:6px;margin-bottom:8px}
    .banks{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .bank-pill{padding:6px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
    .bank-pill.active{background:rgba(255,255,255,0.03)}
    .task-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow:auto;margin-top:6px}
    .task-item{padding:8px;border-radius:8px;border:1px dashed rgba(255,255,255,0.04);cursor:grab;display:flex;justify-content:space-between;align-items:center}
    .task-meta{font-size:12px;color:var(--muted)}
    .task-actions{display:flex;gap:6px}
    .timetable{overflow:auto;border-radius:8px;padding:12px}
    .grid{display:grid;grid-template-columns:80px 1fr;min-width:720px}
    .times{display:flex;flex-direction:column}
    .time-slot{height:var(--slot-height);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;border-top:1px solid rgba(255,255,255,0.02)}
    .slots{background:linear-gradient(180deg, rgba(6,10,20,0.3), rgba(6,10,20,0.2));padding:6px;border-radius:8px}
    .slot{height:var(--slot-height);border-top:1px dashed rgba(255,255,255,0.03);position:relative}
    .slot.highlight{background:linear-gradient(90deg, rgba(96,165,250,0.06), rgba(96,230,168,0.03))}
    .placed{position:absolute;left:6px;right:6px;padding:6px;border-radius:8px;background:linear-gradient(90deg, rgba(96,165,250,0.16), rgba(96,230,168,0.08));border:1px solid rgba(96,165,250,0.12);color:#05202b}
    .small{font-size:12px;color:var(--muted)}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
    .search{display:flex;gap:6px;align-items:center}
    @media (max-width:900px){.layout{grid-template-columns:1fr}.grid{min-width:unset}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>Interactive Timetable Scheduler â€” Enhanced</h1>
        <div class="small">Recurring tasks, direct placement, multiple banks, color picker, categories, search & more.</div>
      </div>
      <div class="controls">
        <button id="loadBtn">Load</button>
        <button id="exportBtn">Export JSON</button>
        <button id="importBtn">Import JSON</button>
        <button id="printBtn" class="primary">Print</button>
      </div>
    </header>

    <div class="layout">
      <aside class="panel">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label for="bankName">Create/Select Bank</label>
            <div style="display:flex;gap:6px">
              <input id="bankName" placeholder="New bank name" />
              <button id="createBank">Create</button>
            </div>
          </div>
        </div>
        <div class="banks" id="banksRoot" aria-live="polite"></div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <input id="searchTask" placeholder="Search tasks..." />
          <button id="filterBtn">Filter</button>
        </div>

        <div style="margin-top:12px">
          <label for="taskName">Task name</label>
          <input id="taskName" placeholder="e.g., Deep work / Prayer" />
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="flex:1">
            <label for="taskDur">Duration (minutes)</label>
            <input id="taskDur" type="number" value="60" />
          </div>
          <div style="width:120px">
            <label for="taskColor">Color</label>
            <input id="taskColor" type="color" value="#60a5fa" />
          </div>
        </div>

        <div style="margin-top:8px">
          <label for="category">Category / Tag</label>
          <input id="category" placeholder="Work / Personal / Prayer" />
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label for="recurrence">Recurrence</label>
            <select id="recurrence">
              <option value="none">None</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
          <div style="width:130px">
            <label for="bankSelect">Add to bank</label>
            <select id="bankSelect"></select>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" rows="2" placeholder="Short notes"></textarea>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="addTask">Add to task bank</button>
          <button id="duplicateTask">Duplicate selected</button>
          <button id="clearBank">Clear bank</button>
        </div>

        <div style="margin-top:12px">
          <label>Task bank</label>
          <div class="task-list" id="taskBank" aria-live="polite"></div>
        </div>

        <hr style="margin:12px 0;border-color:rgba(255,255,255,0.02)" />

        <div>
          <label>Direct place task (no drag)</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="placeTaskSelect"></select>
            <input id="placeStart" type="time" />
            <input id="placeDay" type="text" placeholder="e.g., Mon or leave empty for today" />
            <button id="placeBtn">Place</button>
          </div>
          <div class="small" style="margin-top:6px">You can place tasks directly by selecting one from bank, choosing start time and optional day. Recurrence will apply if set on task.</div>
        </div>

        <div style="margin-top:12px">
          <label>Timetable range</label>
          <div style="display:flex;gap:8px">
            <input id="startTime" type="time" value="00:00" />
            <input id="endTime" type="time" value="23:30" />
          </div>
          <div class="small" style="margin-top:6px">If end time is earlier than start, it will treat as next day.</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="renderGrid">Render</button>
            <button id="resetGrid">Reset slots</button>
          </div>
        </div>

      </aside>

      <main class="panel">
        <div class="timetable">
          <div class="grid" id="gridRoot"></div>
        </div>
        <div class="footer">
          <div class="small">Saved to browser localStorage automatically (including banks). Use Export/Import to share.</div>
          <div class="small">Tips: drag to move, double-click to edit, right-click to remove.</div>
        </div>
      </main>
    </div>
  </div>

  <input id="importFile" type="file" accept="application/json" style="display:none" />

  <script>
    // Enhanced timetable scheduler with multiple banks, recurrence, direct placement, color picker, categories, duplicate, search/filter

    const q=(s,el=document)=>el.querySelector(s); const qa=(s,el=document)=>Array.from(el.querySelectorAll(s));

    // State
    let banks = []; // [{id,name,tasks:[] }]
    let placed = []; // [{id,name,duration,color,category,notes,recurrence,startIso,endIso,bankId}]
    const SLOT_MIN = 30;

    // DOM refs
    const taskBank = q('#taskBank'); const addTaskBtn = q('#addTask'); const duplicateTaskBtn = q('#duplicateTask'); const clearBankBtn = q('#clearBank'); const exportBtn = q('#exportBtn'); const importBtn = q('#importBtn'); const loadBtn = q('#loadBtn'); const printBtn = q('#printBtn'); const renderGridBtn = q('#renderGrid'); const resetGridBtn = q('#resetGrid'); const startTimeInput = q('#startTime'); const endTimeInput = q('#endTime'); const importFile = q('#importFile'); const gridRoot = q('#gridRoot'); const bankNameInput = q('#bankName'); const createBankBtn = q('#createBank'); const banksRoot = q('#banksRoot'); const bankSelect = q('#bankSelect'); const searchInput = q('#searchTask'); const filterBtn = q('#filterBtn'); const placeTaskSelect = q('#placeTaskSelect'); const placeStart = q('#placeStart'); const placeBtn = q('#placeBtn');

    // Init
    function init(){ loadState(); bind(); ensureDefaultBank(); renderBanks(); renderTaskBank(); renderGrid(); renderPlaced(); }

    function bind(){ addTaskBtn.addEventListener('click', onAddTask); duplicateTaskBtn.addEventListener('click', onDuplicate); clearBankBtn.addEventListener('click', ()=>{ if(confirm('Clear current bank tasks?')){ const b = getActiveBank(); if(b){ b.tasks = []; saveState(); renderTaskBank(); renderPlaceSelect(); }}}); exportBtn.addEventListener('click', onExport); importBtn.addEventListener('click', ()=>importFile.click()); importFile.addEventListener('change', onImportFile); loadBtn.addEventListener('click', ()=>{ loadState(true); renderBanks(); renderTaskBank(); renderGrid(); renderPlaced(); alert('Loaded'); }); printBtn.addEventListener('click', ()=>window.print()); renderGridBtn.addEventListener('click', ()=>{ renderGrid(true); }); resetGridBtn.addEventListener('click', ()=>{ if(confirm('Remove all placed tasks?')){ placed=[]; saveState(); renderPlaced(); }}); createBankBtn.addEventListener('click', ()=>{ const name = bankNameInput.value.trim(); if(!name) return alert('Enter bank name'); createBank(name); bankNameInput.value=''; }); searchInput.addEventListener('input', ()=>renderTaskBank()); filterBtn.addEventListener('click', ()=>{ const f = prompt('Filter by category (leave empty to clear)'); renderTaskBank(f); }); placeBtn.addEventListener('click', onDirectPlace);
    }

    function ensureDefaultBank(){ if(banks.length===0){ createBank('Default'); } }

    function createBank(name){ const id='b_'+Date.now(); banks.push({id,name,tasks:[]}); saveState(); renderBanks(); setActiveBank(id); }

    function setActiveBank(id){ banks.forEach(b=>b.active = (b.id===id)); saveState(); renderBanks(); renderTaskBank(); renderPlaceSelect(); }

    function getActiveBank(){ return banks.find(b=>b.active) || banks[0]; }

    // Add task to bank
    function onAddTask(){ const name = q('#taskName').value.trim(); const dur = parseInt(q('#taskDur').value,10) || 30; const color = q('#taskColor').value || '#60a5fa'; const cat = q('#category').value.trim(); const notes = q('#notes').value.trim(); const rec = q('#recurrence').value; const bankId = bankSelect.value || getActiveBank().id; if(!name) return alert('Please enter a task name'); const t = {id:'t_'+Date.now(),name,duration:dur,color,category:cat,notes,recurrence:rec}; const bank = banks.find(b=>b.id===bankId); if(!bank) return alert('No bank selected'); bank.tasks.push(t); saveState(); renderTaskBank(); renderPlaceSelect(); q('#taskName').value=''; q('#notes').value=''; }

    function onDuplicate(){ // duplicate selected from active bank (if one selected via placeTaskSelect)
      const sel = placeTaskSelect.value; if(!sel) return alert('Select a task to duplicate from dropdown'); const [bankId,taskId] = sel.split('::'); const bank = banks.find(b=>b.id===bankId); if(!bank) return; const t = bank.tasks.find(x=>x.id===taskId); if(!t) return; const copy = {...t,id:'t_'+Date.now(),name:t.name+' (copy)'}; bank.tasks.push(copy); saveState(); renderTaskBank(); renderPlaceSelect(); }

    function renderBanks(){ banksRoot.innerHTML=''; bankSelect.innerHTML=''; banks.forEach(b=>{ const pill = document.createElement('div'); pill.className='bank-pill'+(b.active? ' active':''); pill.textContent=b.name; pill.title='Click to select bank'; pill.addEventListener('click', ()=>setActiveBank(b.id)); banksRoot.appendChild(pill); const opt = document.createElement('option'); opt.value=b.id; opt.textContent=b.name; bankSelect.appendChild(opt); }); }

    function renderTaskBank(filterCategory=''){ taskBank.innerHTML=''; const bank = getActiveBank(); if(!bank) return; const qtxt = searchInput.value.trim().toLowerCase(); const list = bank.tasks.filter(t=>{ if(filterCategory && t.category!==filterCategory) return false; if(qtxt && !(t.name.toLowerCase().includes(qtxt) || (t.category||'').toLowerCase().includes(qtxt) || (t.notes||'').toLowerCase().includes(qtxt))) return false; return true; }); if(list.length===0){ taskBank.innerHTML='<div class="small">No tasks in this bank.</div>'; return; } list.forEach(t=>{ const el = document.createElement('div'); el.className='task-item'; el.draggable=true; el.dataset.id=t.id; el.innerHTML = `<div><strong>${escapeHtml(t.name)}</strong><div class="task-meta">${t.duration} min â€¢ ${escapeHtml(t.category||'')} ${t.recurrence!=='none' ? 'â€¢ '+t.recurrence:''}</div></div>`; el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({type:'bank',bankId:bank.id,taskId:t.id})); e.dataTransfer.effectAllowed='copy'; }); const actions = document.createElement('div'); actions.className='task-actions'; const dup = document.createElement('button'); dup.textContent='âŽ˜'; dup.title='Duplicate'; dup.addEventListener('click',(ev)=>{ ev.stopPropagation(); const copy = {...t,id:'t_'+Date.now(),name:t.name+' (copy)'}; bank.tasks.push(copy); saveState(); renderTaskBank(); renderPlaceSelect(); }); const del = document.createElement('button'); del.textContent='ðŸ—‘'; del.title='Delete'; del.addEventListener('click',(ev)=>{ ev.stopPropagation(); if(confirm('Delete this task?')){ bank.tasks = bank.tasks.filter(x=>x.id!==t.id); saveState(); renderTaskBank(); renderPlaceSelect(); } }); actions.appendChild(dup); actions.appendChild(del); el.appendChild(actions); el.addEventListener('dblclick', ()=>{ editTask(bank.id,t.id); }); taskBank.appendChild(el); }); }

    function renderPlaceSelect(){ placeTaskSelect.innerHTML=''; banks.forEach(b=>{ b.tasks.forEach(t=>{ const opt = document.createElement('option'); opt.value = `${b.id}::${t.id}`; opt.textContent = `${b.name} â€” ${t.name} (${t.duration}m${t.recurrence!=='none'?', '+t.recurrence:''})`; placeTaskSelect.appendChild(opt); }); }); }

    function editTask(bankId,taskId){ const bank = banks.find(b=>b.id===bankId); if(!bank) return; const t = bank.tasks.find(x=>x.id===taskId); if(!t) return; const newName = prompt('Edit task name', t.name); if(newName===null) return; t.name = newName.trim()||t.name; const newDur = prompt('Edit duration in minutes', String(t.duration)); if(newDur!==null){ const d=parseInt(newDur,10); if(isFinite(d)&&d>0){ t.duration=d; } } saveState(); renderTaskBank(); renderPlaceSelect(); }

    // Grid rendering
    function renderGrid(force=false){ const start = parseTime(startTimeInput.value||'00:00'); const end = parseTime(endTimeInput.value||'23:30'); const timeline = buildTimeline(start,end); gridRoot.innerHTML=''; const left = document.createElement('div'); left.className='times'; timeline.forEach(slot=>{ const t = document.createElement('div'); t.className='time-slot'; t.textContent = slot.label; left.appendChild(t); }); const right = document.createElement('div'); right.className='slots'; timeline.forEach(slot=>{ const s = document.createElement('div'); s.className='slot'; s.dataset.time = slot.iso; s.addEventListener('dragover', e=>{ e.preventDefault(); s.classList.add('highlight'); e.dataTransfer.dropEffect='copy'; }); s.addEventListener('dragleave', e=>{ s.classList.remove('highlight'); }); s.addEventListener('drop', e=>{ s.classList.remove('highlight'); onDrop(e,slot); }); right.appendChild(s); }); gridRoot.appendChild(left); gridRoot.appendChild(right); renderPlaced(); }

    function renderPlaced(){ qa('.slot').forEach(s=>s.innerHTML=''); // clear
      placed.forEach(p=>{
        // If recurrence is weekly/daily we still place on grid as individual item (visualization: show primary instance)
        const start = p.startIso; const end = p.endIso; const slots = qa('.slot').filter(s=>{ const t = s.dataset.time; return t>=start && t<end; }); if(slots.length===0) return; const first = slots[0]; const el = document.createElement('div'); el.className='placed'; el.dataset.placedId = p.id; el.style.background = `linear-gradient(90deg, ${hexToRgba(p.color,0.14)}, ${hexToRgba(p.color,0.04)})`; el.style.borderColor = hexToRgba(p.color,0.2); el.style.height = `calc(${slots.length} * var(--slot-height) - 12px)`; el.innerHTML = `<strong>${escapeHtml(p.name)}</strong><div class="meta small">${formatTimeLabel(p.startIso)} â€” ${formatTimeLabel(p.endIso)} â€¢ ${p.duration} min ${p.recurrence!=='none'? 'â€¢ '+p.recurrence:''}</div>`; el.draggable=true; el.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', JSON.stringify({type:'placed',placedId:p.id})); e.dataTransfer.effectAllowed='move'; }); el.addEventListener('dblclick', ()=>{ editPlaced(p.id); }); el.addEventListener('contextmenu', e=>{ e.preventDefault(); if(confirm('Remove this placed task?')){ placed = placed.filter(x=>x.id!==p.id); saveState(); renderPlaced(); } }); first.appendChild(el);
      }); }

    function onDrop(e,slot){ const data = e.dataTransfer.getData('text/plain'); if(!data) return; let parsed; try{ parsed=JSON.parse(data);}catch(err){return} if(parsed.type==='bank'){ const bankId = parsed.bankId; const taskId = parsed.taskId; const bank = banks.find(b=>b.id===bankId); if(!bank) return; const task = bank.tasks.find(t=>t.id===taskId); if(!task) return; placeTask(task,slot.iso,bankId); } else if(parsed.type==='placed'){ const pid = parsed.placedId; const p = placed.find(x=>x.id===pid); if(!p) return; const dur = p.duration; const newStart = slot.iso; const newEnd = addMinutesISO(newStart,dur); p.startIso=newStart; p.endIso=newEnd; saveState(); renderPlaced(); } }

    function placeTask(task, startIso, bankId){ const dur = task.duration; const endIso = addMinutesISO(startIso,dur); const overlapping = placed.filter(p=> !(p.endIso<=startIso || p.startIso>=endIso)); if(overlapping.length){ if(!confirm('This placement overlaps with existing tasks. Continue?')) return; } const p = { id:'p_'+Date.now(), name:task.name, duration:dur, color:task.color, category:task.category, notes:task.notes, recurrence:task.recurrence||'none', startIso, endIso, bankId }; placed.push(p); saveState(); renderPlaced(); }

    function onDirectPlace(){ const sel = placeTaskSelect.value; if(!sel) return alert('Select a task to place'); const [bankId,taskId] = sel.split('::'); const bank = banks.find(b=>b.id===bankId); if(!bank) return; const task = bank.tasks.find(t=>t.id===taskId); if(!task) return; const time = placeStart.value; if(!time) return alert('Choose start time'); // compute iso
      const iso = time; // treat only time-of-day for this simplified example
      placeTask(task, iso, bankId);
    }

    function editPlaced(id){ const p = placed.find(x=>x.id===id); if(!p) return; const newName = prompt('Edit name', p.name); if(newName===null) return; p.name=newName.trim()||p.name; const newDur = prompt('Edit duration (min)', String(p.duration)); if(newDur!==null){ const d = parseInt(newDur,10); if(isFinite(d)&&d>0){ p.duration=d; p.endIso = addMinutesISO(p.startIso,d); } } const newRec = prompt('Recurrence (none/daily/weekly)', p.recurrence||'none'); if(newRec!==null) p.recurrence = ['none','daily','weekly'].includes(newRec)?newRec:p.recurrence; saveState(); renderPlaced(); }

    // Persistence
    function saveState(){ const state = {banks,placed,startTime:startTimeInput.value,endTime:endTimeInput.value}; localStorage.setItem('timetable_v2', JSON.stringify(state)); }
    function loadState(showAlert=false){ const raw = localStorage.getItem('timetable_v2'); if(!raw) return; try{ const s = JSON.parse(raw); banks = s.banks||[]; placed = s.placed||[]; if(s.startTime) startTimeInput.value = s.startTime; if(s.endTime) endTimeInput.value = s.endTime; }catch(e){console.error(e)} if(showAlert) alert('Loaded saved timetable'); }

    function onExport(){ const data = {banks,placed,startTime:startTimeInput.value,endTime:endTimeInput.value,exportedAt:new Date().toISOString()}; const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='timetable-export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function onImportFile(e){ const f = e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data = JSON.parse(r.result); if(confirm('Replace current schedule with imported data?')){ banks = data.banks||[]; placed = data.placed||[]; if(data.startTime) startTimeInput.value = data.startTime; if(data.endTime) endTimeInput.value = data.endTime; saveState(); renderBanks(); renderTaskBank(); renderGrid(); renderPlaced(); alert('Imported'); } }catch(err){ alert('Invalid JSON file'); } }; r.readAsText(f); importFile.value=''; }

    // Time helpers
    function parseTime(s){ const [hh,mm] = (s||'00:00').split(':').map(x=>parseInt(x,10)); return {hh,mm}; }
    function addMinutesISO(iso,mins){ let [hh,mm] = iso.split(':').map(x=>parseInt(x,10)); let total = hh*60+mm+mins; total = ((total%1440)+1440)%1440; const H = String(Math.floor(total/60)).padStart(2,'0'); const M = String(total%60).padStart(2,'0'); return `${H}:${M}`; }
    function buildTimeline(startObj,endObj){ const startMin = startObj.hh*60+startObj.mm; const endMin = endObj.hh*60+endObj.mm; let timeline=[]; let cur = startMin; const target = endMin<=startMin? endMin+1440:endMin; while(cur<target){ const h = Math.floor((cur%1440)/60); const m = cur%60; const iso = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; timeline.push({iso,label:formatTimeLabel(iso)}); cur+=SLOT_MIN; } return timeline; }
    function formatTimeLabel(iso){ const [hh,mm]=iso.split(':').map(x=>parseInt(x,10)); const am = hh<12; const H = hh%12===0?12:hh%12; return `${H}:${String(mm).padStart(2,'0')} ${am?'AM':'PM'}`; }

    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function hexToRgba(hex,alpha){ if(!hex) hex='#60a5fa'; const cleaned = hex.replace('#',''); const bigint = parseInt(cleaned,16); const r=(bigint>>16)&255; const g=(bigint>>8)&255; const b=bigint&255; return `rgba(${r},${g},${b},${alpha})`; }

    // initial load
    init();
  </script>
</body>
</html>
